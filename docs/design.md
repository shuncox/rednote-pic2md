# 小红书图片转Markdown工具 - 设计文档

## 项目概述

本项目是一个基于Python和PyQt6的桌面应用程序，旨在将小红书上的多页图片文章转换为Markdown格式的文档。应用程序支持多种OCR服务，能够自动识别系列文件，并生成格式化的Markdown文档。

## 系统架构

### 模块结构

```
pic2md/
├── src/                    # 源代码目录
│   ├── __init__.py        # 包初始化文件
│   ├── app.py             # 应用程序入口
│   ├── main_window.py     # 主界面UI模块
│   ├── file_parser.py     # 文件名解析和排序模块
│   ├── ocr_service.py     # OCR服务集成模块
│   └── markdown_processor.py # Markdown处理模块
├── docs/                   # 文档目录
├── test/                   # 测试目录
├── run.py                  # 启动脚本
└── pyproject.toml         # 项目配置文件
```

### 核心模块

#### 1. 主界面模块 (main_window.py)

负责创建和管理应用程序的图形用户界面，包含以下主要组件：

- **文件选择区域**: 支持单文件和多文件选择
- **文件列表管理**: 支持添加、删除、清空和拖拽排序
- **OCR设置区域**: 支持多种OCR服务的配置
- **输出设置区域**: 支持选择输出目录和文件名
- **转换控制区域**: 包含转换按钮、进度条和状态显示
- **预览区域**: 实时显示生成的Markdown内容

主要类：
- `MainWindow`: 主窗口类
- `FileListWidget`: 自定义文件列表控件，支持拖拽
- `OcrWorker`: OCR处理工作线程，避免界面阻塞

**新增功能**:
- 配置自动保存机制，延迟保存避免频繁写入
- 详细的进度显示和状态反馈
- 智能错误处理和用户友好的错误提示

#### 2. 文件解析模块 (file_parser.py)

负责解析小红书图片文件名并生成有序的文件列表：

- **文件名解析**: 使用正则表达式解析小红书文件名格式
- **系列文件检测**: 根据选中文件自动检测同系列的其他文件
- **文件排序**: 根据文件名中的页码进行排序
- **完整性验证**: 检查文件系列是否完整

主要类：
- `FileParser`: 文件名解析器

支持的文件名格式：
```
{标题}_{页码}_{作者}_来自小红书网页版.{扩展名}
```

#### 3. OCR服务模块 (ocr_service.py)

提供多种OCR API的统一接口：

- **百度OCR**: 支持通用文字识别
- **腾讯云OCR**: 支持高精度文字识别
- **阿里云OCR**: 支持多场景文字识别

主要类：
- `OcrProvider`: OCR提供者抽象基类
- `BaiduOcrProvider`: 百度OCR实现
- `TencentOcrProvider`: 腾讯云OCR实现
- `AliyunOcrProvider`: 阿里云OCR实现
- `OcrService`: OCR服务管理器

**新增功能**:
- 智能图片尺寸处理，自动压缩超大图片
- 严格的QPS控制机制，避免API限制
- 详细的错误码映射和处理
- 全面的图片格式验证

#### 4. Markdown处理模块 (markdown_processor.py)

负责处理OCR结果并生成格式化的Markdown文档：

- **文本清理**: 修复常见的OCR识别错误
- **段落分割**: 智能分割文本段落
- **段落衔接**: 处理页面之间的段落连接
- **格式化**: 生成符合Markdown规范的文档

主要类：
- `MarkdownProcessor`: Markdown处理器
- `PageContent`: 页面内容数据类

**新增功能**:
- 智能句子级别分割
- 优化的段落格式化
- 改进的文档结构布局

#### 5. 配置管理模块 (config_manager.py)

负责应用程序配置的保存和加载：

- **OCR配置**: 各种OCR服务的API密钥和设置
- **输出配置**: 输出目录和文件名模式
- **UI配置**: 界面布局和状态
- **性能配置**: QPS限制和性能参数

主要类：
- `ConfigManager`: 配置管理器

#### 6. 日志系统模块 (logger.py)

提供详细的调试和运行日志：

- **双重输出**: 控制台和文件日志
- **多级别日志**: DEBUG、INFO、WARNING、ERROR
- **自动轮转**: 按日期自动创建日志文件
- **详细信息**: 包含函数名、行号等调试信息

主要类：
- `Logger`: 日志工具类

## 数据流

1. **文件选择**: 用户选择图片文件
2. **文件解析**: 系统解析文件名并检测系列文件
3. **OCR配置**: 用户配置OCR服务参数
4. **文字识别**: 依次处理每个图片文件
5. **内容处理**: 清理和格式化识别结果
6. **文档生成**: 生成Markdown文档
7. **预览保存**: 预览并保存最终文档

## 技术栈

- **编程语言**: Python 3.8+
- **UI框架**: PyQt6
- **依赖管理**: uv
- **OCR服务**: 百度OCR、腾讯云OCR、阿里云OCR
- **图像处理**: Pillow
- **网络请求**: requests

## 配置管理

### OCR服务配置

每种OCR服务需要不同的配置参数：

#### 百度OCR
- API Key
- Secret Key

#### 腾讯云OCR
- Secret Id
- Secret Key
- 区域（可选，默认ap-beijing）

#### 阿里云OCR
- Access Key ID
- Access Key Secret
- 区域（可选，默认cn-shanghai）

### 应用程序设置

- 输出目录设置
- 文件命名规则
- 界面布局偏好
- OCR服务偏好

## 错误处理

### 文件处理错误
- 文件不存在
- 文件格式不支持
- 文件权限问题

### OCR服务错误
- API认证失败
- 网络连接问题
- 识别失败
- 配额超限

### 文档生成错误
- 文本编码问题
- 磁盘空间不足
- 文件写入权限

## 性能优化

1. **多线程处理**: 使用工作线程处理OCR任务，避免界面阻塞
2. **进度反馈**: 实时显示处理进度和状态
3. **缓存机制**: 缓存OCR结果，避免重复处理
4. **批量处理**: 优化批量文件处理流程

## 扩展性设计

1. **插件架构**: 支持添加新的OCR服务提供者
2. **模板系统**: 支持自定义Markdown模板
3. **配置扩展**: 支持更多配置选项
4. **国际化**: 支持多语言界面

## 测试策略

1. **单元测试**: 测试各个模块的核心功能
2. **集成测试**: 测试模块间的协作
3. **UI测试**: 测试用户界面交互
4. **性能测试**: 测试处理大量文件时的性能

## 部署说明

### 环境要求
- Python 3.8+
- 操作系统: Windows、macOS、Linux

### 安装步骤
1. 克隆项目代码
2. 使用uv安装依赖: `uv sync`
3. 运行应用程序: `uv run python run.py`

### 打包发布
可以使用PyInstaller等工具将应用程序打包为可执行文件：

```bash
uv run pyinstaller --windowed --onefile run.py
```

## 安全考虑

1. **API密钥安全**: 不在代码中硬编码API密钥
2. **输入验证**: 验证用户输入的文件路径和配置
3. **错误信息**: 避免在错误信息中泄露敏感信息
4. **网络安全**: 使用HTTPS连接OCR服务

## 维护计划

1. **定期更新**: 跟进OCR服务的API更新
2. **Bug修复**: 及时修复用户反馈的问题
3. **功能增强**: 根据用户需求添加新功能
4. **性能优化**: 持续优化处理性能